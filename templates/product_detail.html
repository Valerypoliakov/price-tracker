{% extends "base.html" %}
{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/dashboard" style="color: #3498db; text-decoration: none;">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
</div>

<div class="card" style="margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
        <div>
            <span class="store-badge store-{{ product.store }}" style="margin-bottom: 10px; display: inline-block;">
                {% if product.store == 'ozon' %}Ozon
                {% elif product.store == 'wildberries' %}Wildberries
                {% elif product.store == 'yandex_market' %}–Ø–Ω–¥–µ–∫—Å.–ú–∞—Ä–∫–µ—Ç
                {% elif product.store == 'megamarket' %}MegaMarket
                {% endif %}
            </span>
            <h2 style="margin-bottom: 8px;">{{ product.name }}</h2>
            <a href="{{ product.url }}" target="_blank" style="color: #3498db; font-size: 14px;">–û—Ç–∫—Ä—ã—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ ‚Üí</a>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 36px; font-weight: 700; color: #2c3e50;">
                {% if product.current_price %}
                    {{ "{:,.0f}".format(product.current_price) }} ‚ÇΩ
                {% else %}
                    –¶–µ–Ω–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
                {% endif %}
            </div>
            {% if product.target_price %}
                <div style="font-size: 14px; color: #666;">
                    –¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞: {{ "{:,.0f}".format(product.target_price) }} ‚ÇΩ
                    {% if product.current_price and product.current_price <= product.target_price %}
                        <span style="color: #27ae60; font-weight: 600;">‚úì –î–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!</span>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% if history %}
<div class="card">
    <h3 style="margin-bottom: 20px;">üìà –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω</h3>
    <canvas id="priceChart" height="100"></canvas>

    <table style="width: 100%; border-collapse: collapse; margin-top: 24px; font-size: 14px;">
        <thead>
            <tr style="border-bottom: 2px solid #eee;">
                <th style="text-align: left; padding: 10px;">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                <th style="text-align: right; padding: 10px;">–¶–µ–Ω–∞</th>
                <th style="text-align: right; padding: 10px;">–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
            </tr>
        </thead>
        <tbody>
            {% for record in history|reverse %}
            <tr style="border-bottom: 1px solid #f0f0f0;">
                <td style="padding: 10px; color: #666;">{{ record.checked_at.strftime('%d.%m.%Y %H:%M') }}</td>
                <td style="padding: 10px; text-align: right; font-weight: 600;">{{ "{:,.0f}".format(record.price) }} ‚ÇΩ</td>
                <td style="padding: 10px; text-align: right;">
                    {% if loop.index < history|length %}
                        {% set prev = history[history|length - loop.index - 1] %}
                        {% set diff = record.price - prev.price %}
                        {% if diff < 0 %}
                            <span style="color: #27ae60;">‚ñº {{ "{:,.0f}".format(diff|abs) }} ‚ÇΩ</span>
                        {% elif diff > 0 %}
                            <span style="color: #e74c3c;">‚ñ≤ {{ "{:,.0f}".format(diff) }} ‚ÇΩ</span>
                        {% else %}
                            <span style="color: #666;">‚Äî</span>
                        {% endif %}
                    {% else %}
                        <span style="color: #666;">‚Äî</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
    const labels = [{% for record in history %}"{{ record.checked_at.strftime('%d.%m %H:%M') }}"{% if not loop.last %},{% endif %}{% endfor %}];
    const data = [{% for record in history %}{{ record.price }}{% if not loop.last %},{% endif %}{% endfor %}];

    new Chart(document.getElementById('priceChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '–¶–µ–Ω–∞ (‚ÇΩ)',
                data: data,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 2,
                pointRadius: 4,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    ticks: {
                        callback: value => value.toLocaleString('ru-RU') + ' ‚ÇΩ'
                    }
                }
            }
        }
    });
</script>
{% else %}
<div class="card" style="text-align: center; padding: 40px;">
    <div style="font-size: 36px; margin-bottom: 12px;">üìä</div>
    <h3>–ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω –ø–æ–∫–∞ –ø—É—Å—Ç–∞</h3>
    <p style="color: #666; margin-top: 8px;">–¶–µ–Ω—ã –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å</p>
</div>
{% endif %}
{% endblock %}